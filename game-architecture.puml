@startuml
skinparam classAttributeIconSize 0
skinparam nodesep 80
skinparam ranksep 100

' ===== 接口层 =====
interface "Entity" <<interface>> {
  +UUID getId()
  +double getX()/getY()/getWidth()/getHeight()
  +double getRotation()
  +boolean isAlive()
  +void markDead()
  +void update(deltaTime)
  +boolean intersects(Entity)
  +boolean handleCollision(Entity, GameContext)
  +int getZIndex()
  +void render(GraphicsContext, GameContext)
}

interface "Controllable" <<interface>> {
  +int getTeamIndex()
  +void setVelocity(vx, vy)
  +double[] getVelocity()
  +void setRotation(rotation)
  +void setPosition(x, y)
  +void noticeOutOfBounds()
}

interface "GameConfig" <<interface>> {
  +double getTargetFps()
  +double getFrameTime()
}

interface "MapProvider" <<interface>> {
  +String getMapName()
  +int getMapWidth()/getMapHeight()
  +void createEntities(GameContext)
  +void update(deltaTime, GameContext)
  +void onKeyPressed/Released(KeyCode, GameContext)
  +void initResources(GameContext)
}

interface "RuleProvider" <<interface>> {
  +boolean isGameOver(GameContext)
  +int getWinner(GameContext)
  +String getGameOverMessage(GameContext)
}

' ===== 单例核心 =====
class "GameContext" <<Singleton>> {
  -static GameContext INSTANCE
  +GameState state
  -MapProvider mapProvider
  -RuleProvider ruleProvider
  -GameEngine engine
  -GameConfig config
  +getInstance(): GameContext
  +getConfig()/setConfig()
  +getMapProvider()/setMapProvider()
  +getRuleProvider()/setRuleProvider()
  +getEngine()/setGameEngine()
  +getState()
  +reset()
  +getSound/Image/Event/InputManager()
}

class "EventBus" <<Singleton>> {
  -static EventBus INSTANCE
  -Map<String, List<Consumer>> eventTypeListeners
  +getInstance(): EventBus
  +subscribe(eventType, listener)
  +unsubscribe(eventType, listener)
  +publish(GameEvent)
  +clear()/clearType(eventType)
  +getListenerCount(eventType)
}

class "SoundManager" <<Singleton>> {
  -static SoundManager INSTANCE
  -Map<String, Clip> sounds
  -double globalVolume
  +getInstance(): SoundManager
  +loadSound(key, filePath)
  +playBGM(key)
  +playSoundEffect(key)
  +stopSound(key)
  +cleanup()
}

class "ImageManager" <<Singleton>> {
  -static ImageManager INSTANCE
  -Map<String, Image> images
  +getInstance(): ImageManager
  +loadImage(key, filePath)
  +getImage(key)
  +unloadImage(key)
  +cleanup()
}

class "InputManager" <<Singleton>> {
  -static Set<KeyCode> pressedKeys
  +getInstance(): InputManager
  +pressKey(key)
  +releaseKey(key)
  +isKeyPressed(key)
  +clear()
}

' ===== 引擎层 =====
class "GameEngine" {
  -GameContext context
  -EventBus eventBus
  -GameConfig config
  +GameEngine()
  +initialize()
  +initResources()
  +start()/stop()/pause()/resume()
  -gameLoop()
  -update(deltaTime)
  -enforceBoundaries()
  -detectCollisionsAndRespond(oldPositions)
  -cleanupDeadEntities()
  +handleKeyPress/Release(KeyCode)
  +getState(): GameState
  +getConfig(): GameConfig
}

class "GameState" {
  -boolean running, paused
  -List<Object> entities
  -Map<Integer, List> teamEntities
  -Map<Integer, Object> teamBases
  -double worldWidth, worldHeight
  +is/setRunning()/is/setPaused()
  +getEntities(): List
  +addEntity(entity)
  +removeEntity(entity)
  +getTeamEntities(): Map
  +getTeamEntityList(teamIndex)
  +add/removeTeamEntity(teamIndex, entity)
  +set/getTeamBase(teamIndex)
  +get/setWorldWidth/Height()
  +reset()
}

class "GameEvent" {
  -String type
  -Object data
  -String message
  +GameEvent(type, data, message)
  +getType()/getData()/getMessage()
}

' ===== 实体层 =====
abstract class "BaseEntity" {
  -UUID id
  -double x, y, vx, vy, width, height, rotation
  -boolean alive
  +BaseEntity(x, y, width, height)
  +getId()
  +getX()/getY()/getWidth()/getHeight()
  +getRotation()
  +boolean isAlive()
  +int getZIndex()
  +markDead()
  +render(GraphicsContext, GameContext)
  +update(deltaTime)
  +intersects(Entity)
  +handleCollision(Entity, GameContext)
  +setPosition(x, y)
}

abstract class "BaseTankEntity" {
  -int teamIndex, health
  -double rotation, vx, vy
  -double fireCooldown
  -double speedBoostTimer
  -boolean isFrozen
  -double frozenTimer, savedVx, savedVy
  +BaseTankEntity(x, y, teamIndex)
  +handleInput(deltaTime, context)*
  +render(gc, context)
  +update(deltaTime)
  +handleCollision(other, context)
  +getTeamIndex()
  +setPosition(x, y)
  +setRotation(rotation)
  +getVelocity(): double[]
  +setVelocity(vx, vy)
  +canFire(): boolean
  +fireShell(context)
  +takeDamage(damage)
  +activateSpeedBoost()
  +getSpeedMultiplier()
  +noticeOutOfBounds()
  +freeze(duration)
  +unfreeze()
  +isFrozen()
}

' ===== UI层 =====
class "GUI" <<JavaFX>> {
  -static GUI instance
  -static GameContext staticContext
  -Canvas canvas
  -GameRenderer renderer
  -GameContext context
  +getInstance(): GUI
  +setStaticContext(context)
  +start(primaryStage)
}

class "GameRenderer" <<JavaFX>> {
  -Canvas canvas
  -GraphicsContext gc
  -GameEngine engine
  -GameContext context
  -String gameOverMessage
  -int fps
  +GameRenderer(canvas)
  +handle(now)
  +start()
  -updateFrameTime()
  -handleGameOver(event)
}

' ===== 实现类 =====
class "Main" {
  -VERSION: String
  +main(args)
}

class "DefaultGameConfig" {
  +double getTargetFps()
  +double getFrameTime()
}

class "DefaultMapProvider" {
  -Random random
  -double waveTimer, LifeCapsuleTimer
  -int currentWave
  +DefaultMapProvider()
  +String getMapName()
  +int getMapWidth/Height()
  +createEntities(context)
  +update(deltaTime, context)
  +onKeyPressed/Released(key, context)
  +initResources(context)
  -handleSpawnShell(event)
  -updateReinforcement(teamIndex, deltaTime, state)
  -getPlayerTank(context)
  -cleanupAITimers(state)
}

class "DefaultRuleProvider" {
  +isGameOver(context)
  +getWinner(context)
  +getGameOverMessage(context)
}

' ===== 继承关系 =====
"Entity" <|.. "Controllable"
"Entity" <|.. "BaseEntity"
"Controllable" <|.. "BaseTankEntity"
"BaseEntity" <|-- "BaseTankEntity"

"GameConfig" <|.. "DefaultGameConfig"
"MapProvider" <|.. "DefaultMapProvider"
"RuleProvider" <|.. "DefaultRuleProvider"

' ===== 关联关系 =====
"GameContext" --> "GameState" : contains
"GameContext" --> "EventBus" : uses
"GameContext" --> "GameConfig"
"GameEngine" --> "GameContext" : uses
"GameEngine" --> "GameConfig"
"GameRenderer" --> "GameEngine" : uses
"GameRenderer" --> "GameContext" : uses
"GUI" --> "GameContext" : uses
"GUI" --> "GameRenderer" : creates
"Main" --> "GameEngine" : creates
"Main" --> "GameContext" : configures

' ===== 单例指向 =====
"GameContext" --> "GameContext" : <<singleton>>
"EventBus" --> "EventBus" : <<singleton>>
"SoundManager" --> "SoundManager" : <<singleton>>
"ImageManager" --> "ImageManager" : <<singleton>>
"InputManager" --> "InputManager" : <<singleton>>

note right of "Main"
  1. 创建 Map/Rule/Config Provider
  2. 初始化 GameContext 单例
  3. 创建并初始化 GameEngine
  4. 启动 JavaFX GUI
end note

note bottom of "GameEngine"
  游戏主循环：固定时间步长更新
end note

@enduml