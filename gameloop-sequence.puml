@startuml
skinparam sequenceArrowThickness 2
skinparam sequenceParticipant underline

actor User
participant "GUI" as GUI
participant "GameRenderer" as Renderer
participant "GameEngine" as Engine
participant "GameContext" as Context
participant "GameState" as State
participant "MapProvider" as Map
participant "Entity" as Entity
participant "EventBus" as EventBus

User -> GUI: 启动游戏
activate GUI
GUI -> Engine: initialize()
activate Engine
Engine -> Context: getMapProvider()
Context --> Engine: provider
Engine -> Map: createEntities(context)
activate Map
Map -> State: addEntity(entity)
activate State
State --> Map
deactivate State
Map --> Engine
deactivate Map
GUI -> Renderer: start()
activate Renderer
Renderer -> Engine: start()
Engine -> Engine: gameLoop()
activate Engine

loop 每帧循环
  Engine -> Context: getState()
  Context --> Engine: state
  Engine -> Map: update(deltaTime, context)
  activate Map
  Map -> State: getEntities()
  State --> Map: entities
  Map -> Entity: update(deltaTime)
  activate Entity
  Entity --> Map
  deactivate Entity
  deactivate Map
  
  Engine -> State: getEntities()
  State --> Engine: entities
  
  loop 实体间碰撞检测
    Engine -> Entity: intersects(other)
    activate Entity
    Entity --> Engine: boolean
    deactivate Entity
    
    alt 发生碰撞
      Engine -> Entity: handleCollision(other, context)
      activate Entity
      Entity -> EventBus: publish(event)
      activate EventBus
      EventBus --> Entity
      deactivate EventBus
      Entity --> Engine
      deactivate Entity
    end
  end
  
  Engine -> State: cleanupDeadEntities()
  activate State
  State -> State: removeIf(!isAlive())
  State --> Engine
  deactivate State
  
  -> Renderer: AnimationTimer.handle()
  activate Renderer
  Renderer -> State: getEntities()
  State --> Renderer: entities
  loop 渲染每个实体
    Renderer -> Entity: render(gc, context)
    activate Entity
    Entity --> Renderer
    deactivate Entity
  end
  deactivate Renderer
end

User -> GUI: 按 ESC/Pause
GUI -> Engine: pause()/resume()
Engine -> State: setPaused(true/false)

User -> GUI: 关闭窗口
GUI -> Renderer: stop()
GUI -> Engine: stop()
Engine -> Engine: running = false
deactivate Engine
deactivate GUI

@enduml